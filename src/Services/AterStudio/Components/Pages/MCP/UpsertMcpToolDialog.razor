@using System.ComponentModel.DataAnnotations
@using Entity.StudioMod
@inherits PageBase
@implements IDialogContentComponent<McpTool>

<FluentDialogHeader ShowDismiss="false">
  <FluentLabel Typo="Typography.Subject">
    @if (IsEdit)
    {
      <span>@Lang(Localizer.Edit): @Content?.Name</span>
    }
    else
    {
      <span>@Lang(Localizer.Add)@Lang(Localizer.MCP, Localizer.Tools)</span>
    }
  </FluentLabel>
</FluentDialogHeader>

<EditForm EditContext="@EditContext">
  <DataAnnotationsValidator />
  <ValidationSummary />
  <FluentStack Orientation="Orientation.Vertical" VerticalGap="12">
    <FluentStack Orientation="Orientation.Vertical" VerticalGap="2">
      <FluentTextField @bind-Value="Model.Name"
                       Label="@Lang(Localizer.Name)"
                       Placeholder="@Lang(Localizer.Name)"
                       Class="w-100"
                       Maxlength="40"
                       Required />
    </FluentStack>
    <FluentStack Orientation="Orientation.Vertical" VerticalGap="2">
      <FluentTextField @bind-Value="Model.Description"
                       Label="@Lang(Localizer.Description)"
                       Placeholder="@Lang(Localizer.Description)"
                       Class="w-100"
                       Maxlength="300"
                       Required />
    </FluentStack>
    <FluentStack Orientation="Orientation.Vertical" VerticalGap="2">
      <FluentTextField @bind-Value="Model.PromptPath"
                       Label="@Lang(Localizer.Prompt,Localizer.Path)"
                       Placeholder="@Lang(Localizer.Prompt,Localizer.Path)"
                       Class="w-100"
                       Maxlength="300"
                       Required />
    </FluentStack>

    <FluentStack Orientation="Orientation.Vertical" VerticalGap="2">
      <FluentTextField @bind-Value="TemplatePathsString"
                       Label="@Lang(Localizer.Template,Localizer.Path)"
                       Placeholder="@Lang(Localizer.Template,Localizer.Path)"
                       Class="w-100" />
    </FluentStack>
  </FluentStack>

</EditForm>

<FluentDialogFooter>
  <FluentButton Appearance="Appearance.Accent"
                Type="ButtonType.Button"
                OnClick="SaveAsync">
    @Lang(Localizer.Save)
  </FluentButton>
  <FluentButton Appearance="Appearance.Neutral"
                OnClick="CancelAsync">
    @Lang(Localizer.Cancel)
  </FluentButton>
</FluentDialogFooter>

@code {
  [CascadingParameter]
  FluentDialog Dialog { get; set; } = null!;

  [Parameter]
  public McpTool? Content { get; set; }

  [Inject]
  private McpToolManager McpToolManager { get; set; } = null!;

  EditContext EditContext { get; set; } = null!;

  private McpTool Model { get; set; } = new McpTool { Name = string.Empty, Description = string.Empty, PromptPath = string.Empty };
  private bool IsEdit => Content != null;
  private string TemplatePathsString { get; set; } = string.Empty;

  protected override void OnInitialized()
  {
    if (Content != null)
    {
      Model = new McpTool
      {
        Id = Content.Id,
        Name = Content.Name,
        Description = Content.Description,
        PromptPath = Content.PromptPath,
        TemplatePaths = Content.TemplatePaths?.ToArray() ?? [],
        CreatedTime = Content.CreatedTime,
        UpdatedTime = Content.UpdatedTime,
        IsDeleted = Content.IsDeleted
      };
      TemplatePathsString = string.Join(", ", Model.TemplatePaths ?? []);
    }
    else
    {
      Model = new McpTool { Name = string.Empty, Description = string.Empty, PromptPath = string.Empty };
      TemplatePathsString = string.Empty;
    }
    EditContext = new EditContext(Model);

    EditContext.OnFieldChanged += OnFieldChanged;
  }

  private void OnFieldChanged(object? sender, FieldChangedEventArgs e)
  {
    if (EditContext is not null)
    {
      StateHasChanged();
    }
  }
  private void Dispose()
  {
    if (EditContext != null)
    {
      EditContext.OnFieldChanged -= OnFieldChanged;
    }
  }

  private async Task SaveAsync()
  {
    if (!EditContext.Validate())
    {
      ToastService.ShowError(Lang(Localizer.FormValidFailed));
      return;
    }
    Model.TemplatePaths = TemplatePathsString.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);

    if (IsEdit)
    {
      var entity = await McpToolManager.GetCurrentAsync(Model.Id);
      if (entity != null)
      {
        entity.Merge(Model);
        var res = await McpToolManager.UpdateAsync(entity);
        if (res)
        {
          await Dialog.CloseAsync(entity);
        }
        else
        {
          ToastService.ShowError(Lang(Localizer.Edit, Localizer.Failed));
        }
      }

    }
    else
    {
      var res = await McpToolManager.AddAsync(Model);
      if (res)
      {
        await Dialog.CloseAsync(Model);
      }
      else
      {
        ToastService.ShowError(Lang(Localizer.Add, Localizer.Failed));
      }
    }
  }

  private async Task CancelAsync()
  {
    await Dialog.CancelAsync();
  }
}
