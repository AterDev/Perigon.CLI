@inherits PageBase
@implements IDialogContentComponent<ClientAppItemDto>

<FluentDialogHeader ShowDismiss="false">
    <FluentStack VerticalAlignment="VerticalAlignment.Center">
        <FluentLabel Typo="Typography.PaneHeader">
            @Dialog.Instance.Parameters.Title
        </FluentLabel>
    </FluentStack>
</FluentDialogHeader>

<EditForm EditContext="editContext">
    <DataAnnotationsValidator />
    <FluentValidationSummary />

    <FluentDialogBody>
        <FluentStack Orientation="Orientation.Vertical">
            <FluentTextField @bind-Value="EditDto!.ClientName"
                             Label="@Localizer.Get(LanguageKey.ClientName)"
                             Placeholder="@Localizer.Get(LanguageKey.ClientName)"
                             class="w-100" Required />
            <FluentValidationMessage For="() => EditDto.ClientName"></FluentValidationMessage>

            <FluentTextArea Rows="3" @bind-Value="RedirectUris"
                            Placeholder="@Localizer.Get(LanguageKey.RedirectUris)" Class="w-100"
                            Label="@Localizer.Get(LanguageKey.RedirectUris)"
                            Required />
            <FluentLabel Typo="Typography.Body" Color="Color.Info">
                @Localizer.Get(LanguageKey.RowValueTip)
            </FluentLabel>
            <FluentValidationMessage For="() => EditDto.RedirectUris"></FluentValidationMessage>

        </FluentStack>
    </FluentDialogBody>

    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Accent"
                      Type="ButtonType.Button"
                      Disabled="!formValid"
                      OnClick="SaveAsync">
            @Localizer.Get(LanguageKey.Save)
        </FluentButton>
        <FluentButton Appearance="Appearance.Neutral" OnClick="@CancelAsync">
            @Localizer.Get(LanguageKey.Cancel)
        </FluentButton>
    </FluentDialogFooter>

</EditForm>


@code {
    private EditContext? editContext;
    private ClientAppEditDto? EditDto;
    private bool formValid = false;
    public string RedirectUris { get; set; } = string.Empty;

    [Parameter]
    public ClientAppItemDto Content { get; set; } = default!;

    [CascadingParameter]
    public FluentDialog Dialog { get; set; } = default!;

    [Inject]
    private ApplicationManager ApplicationManager { get; set; } = default!;

    protected override void OnInitialized()
    {
        EditDto ??= new ClientAppEditDto
        {
            ClientName = Content.ClientName,
            RedirectUris = Content.RedirectUris
        };
        RedirectUris = string.Join(Environment.NewLine, Content.RedirectUris);
        editContext = new(EditDto);
        editContext.OnFieldChanged += HandleFieldChanged;

    }
    private void HandleFieldChanged(object? sender, FieldChangedEventArgs e)
    {
        if (editContext is not null)
        {
            formValid = editContext.Validate();
            StateHasChanged();
        }
    }
    public void Dispose()
    {
        if (editContext is not null)
        {
            editContext.OnFieldChanged -= HandleFieldChanged;
        }
    }

    private async Task SaveAsync()
    {
        if (!editContext!.Validate())
        {
            ToastService.ShowError(Lang(LanguageKey.FormValidFailed));

            editContext.NotifyValidationStateChanged();
            return;
        }
        if (EditDto is not null && Content.ClientId is not null)
        {
            if (!string.IsNullOrWhiteSpace(RedirectUris))
            {
                var separators = new[] { "\r\n", "\n" };
                EditDto.RedirectUris = RedirectUris.Split(separators, StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries).Distinct().ToList();
            }
            try
            {
                await ApplicationManager.UpdateAsync(Content.ClientId, EditDto);
                await Dialog.CloseAsync();
            }
            catch (Exception ex)
            {
                ToastService.ShowError(Lang(LanguageKey.Edit, LanguageKey.Failed) + $":{ex.Message}");
                return;
            }
        }
    }

    private async Task CancelAsync()
    {
        await Dialog.CancelAsync();
    }
}
