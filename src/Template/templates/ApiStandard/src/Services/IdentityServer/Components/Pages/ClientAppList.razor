@page "/client-apps"
@using System.Net.Http.Json
@using Microsoft.FluentUI.AspNetCore.Components

<PageTitle>客户端管理</PageTitle>

<FluentButton @onclick="ShowAddDialog">新增客户端</FluentButton>

<FluentDataGrid TItem="ClientAppDto" Items="@apps.AsQueryable()">
    <PropertyColumn TItem="ClientAppDto" Property="@(x => x.ClientId)" Title="ClientId" />
    <PropertyColumn TItem="ClientAppDto" Property="@(x => x.DisplayName)" Title="显示名称" />
    <TemplateColumn TItem="ClientAppDto" Title="重定向URI">
        <ChildContent Context="app">
            @foreach (var uri in app.RedirectUris)
            {
                <div>@uri</div>
            }
        </ChildContent>
    </TemplateColumn>
    <TemplateColumn TItem="ClientAppDto" Title="操作">
        <ChildContent Context="app">
            <FluentButton Size="Small" @onclick="() => Edit(app)">编辑</FluentButton>
            <FluentButton Size="Small" @onclick="() => Delete(app.ClientId)">删除</FluentButton>
        </ChildContent>
    </TemplateColumn>
</FluentDataGrid>

<FluentDialog @bind-Open="dialogOpen">
    <div class="fluent-dialog-title">@(editModel.ClientId == null ? "新增客户端" : "编辑客户端")</div>
    <div class="fluent-dialog-content">
        <FluentTextField @bind-Value="editModel.ClientId" Placeholder="ClientId" />
        <FluentTextField @bind-Value="editModel.DisplayName" Placeholder="显示名称" />
        <FluentTextField @bind-Value="editModel.ClientSecret" Placeholder="ClientSecret" />
        <FluentTextField @bind-Value="editModel.RedirectUri" Placeholder="重定向URI" />
    </div>
    <div class="fluent-dialog-actions">
        <FluentButton @onclick="Save">保存</FluentButton>
        <FluentButton @onclick="() => dialogOpen = false">取消</FluentButton>
    </div>
</FluentDialog>

@code {
    private List<ClientAppDto> apps = [];
    private bool dialogOpen;
    private ClientAppEditModel editModel = new();
    [Inject] public HttpClient Http { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        apps = await Http.GetFromJsonAsync<List<ClientAppDto>>("/api/application") ?? [];
    }

    private void ShowAddDialog()
    {
        editModel = new();
        dialogOpen = true;
    }

    private void Edit(ClientAppDto app)
    {
        editModel = new ClientAppEditModel
        {
            ClientId = app.ClientId,
            DisplayName = app.DisplayName,
            RedirectUri = app.RedirectUris.FirstOrDefault() ?? string.Empty
        };
        dialogOpen = true;
    }

    private async Task Save()
    {
        if (string.IsNullOrWhiteSpace(editModel.ClientId))
        {
            dialogOpen = false;
            return;
        }
        if (apps.Any(x => x.ClientId == editModel.ClientId))
        {
            await Http.PutAsJsonAsync($"/api/application/{editModel.ClientId}", editModel);
        }
        else
        {
            await Http.PostAsJsonAsync("/api/application", editModel);
        }
        dialogOpen = false;
        await LoadData();
    }

    private async Task Delete(string clientId)
    {
        await Http.DeleteAsync($"/api/application/{clientId}");
        await LoadData();
    }

    public class ClientAppDto
    {
        public string ClientId { get; set; } = string.Empty;
        public string DisplayName { get; set; } = string.Empty;
        public List<string> RedirectUris { get; set; } = [];
    }
    public class ClientAppEditModel
    {
        public string? ClientId { get; set; }
        public string? DisplayName { get; set; }
        public string? ClientSecret { get; set; }
        public string? RedirectUri { get; set; }
    }
}
