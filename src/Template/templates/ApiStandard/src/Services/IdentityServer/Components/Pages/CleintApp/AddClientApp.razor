@inherits PageBase
@implements IDialogContentComponent

<FluentDialogHeader ShowDismiss="false">
    <FluentStack VerticalAlignment="VerticalAlignment.Center">
        <FluentLabel Typo="Typography.PaneHeader">
            @Dialog.Instance.Parameters.Title
        </FluentLabel>
    </FluentStack>
</FluentDialogHeader>


<EditForm OnValidSubmit="@SaveAsync" EditContext="editContext">
    <DataAnnotationsValidator />
    <FluentValidationSummary />

    <FluentDialogBody>
        <FluentStack Orientation="Orientation.Vertical">
            <FluentTextField @bind-Value="AddDto!.ClientName"
                             Label="@Localizer.Get(LanguageKey.ClientName)"
                             Placeholder="@Localizer.Get(LanguageKey.ClientName)"
                             class="w-100" Required />
            <FluentValidationMessage For="() => AddDto.ClientName"></FluentValidationMessage>

            <FluentTextArea Rows="3" @bind-Value="RedirectUris"
                            Placeholder="@Localizer.Get(LanguageKey.RedirectUris)" Class="w-100"
                            Label="@Localizer.Get(LanguageKey.RedirectUris)"
                            Required />
            <FluentLabel Typo="Typography.Body" Color="Color.Info">
                @Localizer.Get(LanguageKey.RowValueTip)
            </FluentLabel>
            <FluentValidationMessage For="() => AddDto.RedirectUris"></FluentValidationMessage>

        </FluentStack>
    </FluentDialogBody>

    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Accent" Type="ButtonType.Submit" Disabled="!formValid">
            @Localizer.Get(LanguageKey.Save)
        </FluentButton>
        <FluentButton Appearance="Appearance.Neutral" OnClick="@CancelAsync">
            @Localizer.Get(LanguageKey.Cancel)
        </FluentButton>
    </FluentDialogFooter>

</EditForm>


@code {
    private EditContext? editContext;
    private ClientAppAddDto? AddDto;
    private bool formValid = false;

    public string RedirectUris { get; set; } = string.Empty;

    [CascadingParameter]
    public FluentDialog Dialog { get; set; } = default!;

    [Inject]
    private ApplicationManager ApplicationManager { get; set; } = default!;

    protected override void OnInitialized()
    {
        AddDto ??= new();
        editContext = new(AddDto);
        editContext.OnFieldChanged += HandleFieldChanged;

    }
    private void HandleFieldChanged(object? sender, FieldChangedEventArgs e)
    {
        if (editContext is not null)
        {
            formValid = editContext.Validate();
            StateHasChanged();
        }
    }
    public void Dispose()
    {
        if (editContext is not null)
        {
            editContext.OnFieldChanged -= HandleFieldChanged;

        }
    }

    private async Task SaveAsync()
    {
        if (!string.IsNullOrEmpty(RedirectUris))
        {
            var separators = new[] { "\r\n", "\n" };
            AddDto.RedirectUris = RedirectUris.Split(separators, StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries).Distinct().ToList();
        }

        var res = await ApplicationManager.CreateAsync(AddDto);
        if (res is not null)
        {
            await Dialog.CloseAsync();
        }
        else
        {
            ToastService.ShowError(Lang(LanguageKey.Add, LanguageKey.Failed));
        }
    }

    private async Task CancelAsync()
    {
        await Dialog.CancelAsync();
    }


}
