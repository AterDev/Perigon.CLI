@inherits PageBase
@implements IDialogContentComponent

<FluentDialogHeader ShowDismiss="false">
    <FluentStack VerticalAlignment="VerticalAlignment.Center">
        <FluentLabel Typo="Typography.PaneHeader">
            @Dialog.Instance.Parameters.Title
        </FluentLabel>
    </FluentStack>
</FluentDialogHeader>


<EditForm EditContext="editContext">
    <DataAnnotationsValidator />
    <FluentValidationSummary />

    <FluentDialogBody>
        <FluentStack Orientation="Orientation.Vertical">
            <FluentTextField @bind-Value="AddDto!.ClientName"
                             Label="@Localizer.Get(LanguageKey.ClientName)"
                             Placeholder="@Localizer.Get(LanguageKey.ClientName)"
                             class="w-100" Required />
            <FluentValidationMessage For="() => AddDto.ClientName"></FluentValidationMessage>

            <FluentTextArea Rows="3" @bind-Value="RedirectUris"
                            @onkeydown:stopPropagation
                            Placeholder="@Localizer.Get(LanguageKey.RedirectUris)" Class="w-100"
                            Label="@Localizer.Get(LanguageKey.RedirectUris)"
                            Required />
            <FluentLabel Typo="Typography.Body" Color="Color.Info">
                @Localizer.Get(LanguageKey.RowValueTip)
            </FluentLabel>
            <FluentValidationMessage For="() => AddDto.RedirectUris"></FluentValidationMessage>


        </FluentStack>
    </FluentDialogBody>

    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Accent"
                      Type="ButtonType.Button"
                      Disabled="!formValid"
                      OnClick="SaveAsync">
            @Localizer.Get(LanguageKey.Save)
        </FluentButton>
        <FluentButton Appearance="Appearance.Neutral" OnClick="@CancelAsync">
            @Localizer.Get(LanguageKey.Cancel)
        </FluentButton>
    </FluentDialogFooter>
</EditForm>


@code {
    private EditContext? editContext;
    private ClientAppAddDto? AddDto;
    private bool formValid = false;

    public string RedirectUris { get; set; } = "http://localhost:5200";
    private List<string> grantTypeOptions = new() { "authorization_code", "client_credentials", "password", "refresh_token", "implicit", "device_code" };

    [CascadingParameter]
    public FluentDialog Dialog { get; set; } = default!;

    [Inject]
    private ApplicationManager ApplicationManager { get; set; } = default!;

    protected override void OnInitialized()
    {
        AddDto ??= new();
        editContext = new(AddDto);
        editContext.OnFieldChanged += HandleFieldChanged;

    }
    private void HandleFieldChanged(object? sender, FieldChangedEventArgs e)
    {
        if (editContext is not null)
        {
            formValid = editContext.Validate();
            StateHasChanged();
        }
    }

    private void OnGrantTypeChanged(string grant, object? checkedValue)
    {
        if (checkedValue is bool isChecked)
        {
            if (isChecked)
            {
                if (!AddDto!.GrantTypes.Contains(grant))
                {
                    AddDto.GrantTypes.Add(grant);
                }
            }
            else
            {
                AddDto!.GrantTypes.Remove(grant);
            }
        }
    }

    public void Dispose()
    {
        if (editContext is not null)
        {
            editContext.OnFieldChanged -= HandleFieldChanged;
        }
    }

    private async Task SaveAsync()
    {
        if (!editContext!.Validate())
        {
            ToastService.ShowError(Lang(LanguageKey.FormValidFailed));
            return;
        }
        if (!string.IsNullOrEmpty(RedirectUris))
        {
            var separators = new[] { "\r\n", "\n" };
            if (AddDto != null)
            {

                AddDto.RedirectUris = RedirectUris.Split(separators, StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries).Distinct().ToList();
                var res = await ApplicationManager.CreateAsync(AddDto);
                if (res is not null)
                {
                    await Dialog.CloseAsync();
                }
                else
                {
                    ToastService.ShowError(Lang(LanguageKey.Add, LanguageKey.Failed));
                }
            }
        }
    }

    private async Task CancelAsync()
    {
        await Dialog.CancelAsync();
    }
}
