@page "/client-apps"
@inherits PageBase
@attribute [Authorize]
@using IdentityServer.Managers
@using Microsoft.FluentUI.AspNetCore.Components
@inject IdentityServer.Managers.ApplicationManager AppManager
@inject IDialogService DialogService

<PageTitle>
    @Localizer.Get(LanguageKey.ClientApp) @Localizer.Get(LanguageKey.Management)

</PageTitle>

<FluentButton @onclick="ShowAddDialog" Appearance="Appearance.Accent">
    @Localizer.Get(LanguageKey.Add) @Localizer.Get(LanguageKey.ClientApp)
</FluentButton>

<FluentDataGrid Items="@apps.AsQueryable()">
    <PropertyColumn Property="@(x => x.ClientId)" Title="@Localizer.Get(LanguageKey.ClientId)" />
    <PropertyColumn Property="@(x => x.ClientName)" Title="@Localizer.Get(LanguageKey.ClientName)" />
    <TemplateColumn Title="@Localizer.Get(LanguageKey.RedirectUris)">
        <ChildContent Context="app">
            @foreach (var uri in app.RedirectUris)
            {
                <div>@uri</div>
            }
        </ChildContent>
    </TemplateColumn>
    <TemplateColumn Title="@Localizer.Get(LanguageKey.Actions)">
        <ChildContent Context="app">
            <FluentButton Size="Small" @onclick="() => Edit(app)">@Localizer.Get(LanguageKey.Edit)</FluentButton>
            <FluentButton Size="Small" @onclick="() => Delete(app.ClientId)">@Localizer.Get(LanguageKey.Delete)</FluentButton>
        </ChildContent>
    </TemplateColumn>
</FluentDataGrid>


@code {
    private List<ClientAppDto> apps = [];
    private ClientAppEditModel editModel = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        apps = await AppManager.ListAsync() ?? [];
    }

    private async Task ShowAddDialog()
    {
        DialogParameters parameters = new()
        {
            Title = Localizer.Get(LanguageKey.AddClientApp),
            PrimaryAction = "Yes",
            PrimaryActionEnabled = false,
            SecondaryAction = "No",
            Width = "400px",
            PreventScroll = true
        };

        var dialog = await DialogService.ShowDialogAsync<AddClientAppDialog>(parameters);

        DialogResult? result = await dialog.Result;

        if (result.Data is not null)
        {
            
        }
        else
        {
        }
    }

    private void Edit(ClientAppDto app)
    {
        editModel = new ClientAppEditModel
        {
            ClientId = app.ClientId,
            ClientName = app.ClientName,
            RedirectUri = app.RedirectUris.FirstOrDefault() ?? string.Empty
        };
    }

    private async Task Save()
    {
        if (string.IsNullOrWhiteSpace(editModel.ClientId))
        {
            return;
        }
        if (apps.Any(x => x.ClientId == editModel.ClientId))
        {
            await AppManager.UpdateAsync(editModel.ClientId!, editModel);
        }
        else
        {
            await AppManager.CreateAsync(editModel);
        }
        await LoadData();
    }

    private async Task Delete(string clientId)
    {
        await AppManager.DeleteAsync(clientId);
        await LoadData();
    }
}
