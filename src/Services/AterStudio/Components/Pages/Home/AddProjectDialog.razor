@namespace AterStudio.Components
@inherits PageBase
@implements IDialogContentComponent
@inject SolutionManager SolutionManager

<EditForm EditContext="editContext">
    <FluentDialogHeader ShowDismiss="false">
        <FluentLabel Typo="Typography.PaneHeader">
            @Lang(Localizer.Load, Localizer.Project)
        </FluentLabel>

        <FluentLabel Typo="Typography.Subject" Color="Color.Accent">
            @Lang(Localizer.LoadProjectDes)
        </FluentLabel>
    </FluentDialogHeader>
    <FluentBodyContent>
        <DataAnnotationsValidator />
        <FluentValidationSummary />

        <FluentStack Orientation="Orientation.Vertical" VerticalGap="16">
            <FluentStack VerticalGap="4" Orientation="Orientation.Vertical">
                <FluentTextField @bind-Value="AddDto.ProjectName"
                                 Label="@Lang(Localizer.Project,Localizer.Name)"
                                 Class="w-100"
                                 Required="true"
                                 Placeholder="@Lang(Localizer.Project,Localizer.Name)" />

                <FluentValidationMessage For="@(() => AddDto.ProjectName)" />
            </FluentStack>
            <FluentStack VerticalGap="4" Orientation="Orientation.Vertical">
                <FluentTextField @bind-Value="AddDto.ProjectDirectory"
                                 Label="@Lang(Localizer.Project,Localizer.Directory)"
                                 Required="true"
                                 Placeholder="@Lang(Localizer.LoadProjectPathDes)"
                                 Class="w-100" />
                <FluentValidationMessage For="@(() => AddDto.ProjectDirectory)" />
            </FluentStack>
        </FluentStack>
    </FluentBodyContent>

    <FluentDialogFooter>
        <FluentButton Appearance="Appearance.Accent"
                      Type="ButtonType.Button"
                      OnClick="SaveAsync">
            @Lang(Localizer.Load)
        </FluentButton>
        <FluentButton Appearance="Appearance.Neutral"
                      OnClick="CancelAsync">
            @Lang(Localizer.Cancel)
        </FluentButton>
    </FluentDialogFooter>
</EditForm>

@code {
    [CascadingParameter]
    public FluentDialog Dialog { get; set; } = null!;
    private EditContext? editContext;
    public AddProjectDto AddDto { get; set; } = default!;
    private bool formValid = false;

    protected override void OnInitialized()
    {
        AddDto = new AddProjectDto
        {
            ProjectName = string.Empty,
            ProjectDirectory = string.Empty
        };
        editContext = new EditContext(AddDto);
        editContext.OnFieldChanged += HandleFieldChanged;

    }
    private void HandleFieldChanged(object? sender, FieldChangedEventArgs e)
    {
        if (editContext is not null)
        {
            formValid = editContext.Validate();
            StateHasChanged();
        }
    }

    public void Dispose()
    {
        if (editContext is not null)
        {
            editContext.OnFieldChanged -= HandleFieldChanged;
        }
    }

    private async Task SaveAsync()
    {
        if (!editContext!.Validate())
        {
            ToastService.ShowError(Lang(Localizer.FormValidFailed));
            return;
        }

        if (AddDto != null)
        {
            if (!Directory.Exists(AddDto.ProjectDirectory))
            {
                ToastService.ShowError(Localizer.Get(Localizer.NotFoundWithName, AddDto.ProjectDirectory));
                return;
            }
            var res = await SolutionManager.AddProjectAsync(AddDto.ProjectName, AddDto.ProjectDirectory);
            if (res is not null)
            {
                await Dialog.CloseAsync(res);
            }
            else
            {
                ToastService.ShowError(Lang(Localizer.Add, Localizer.Failed));
            }
        }
    }

    private async Task CancelAsync()
    {
        await Dialog.CancelAsync();
    }
}
